<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Erstsemesterzahlen Uni Lübeck</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
        <style type="text/css">
            body {
                font-family: Helvetica, Arial, sans-serif;
            }

            #pagetitle {
                font-size: 20px;
            }

            .text {
                font-size: 12px;
                color: #666;
                width: 1000px;
            }

            #coursecheckboxes label{
                color: #fff;
                padding: 4px;
            }
        </style>
    </head>
    <body>
        <h1 id="pagetitle">Entwicklung der Erstsemesterzahlen an der Universität zu Lübeck</h1>
        <p id="description" class="text">Dargestellt sind die Erstsemesterzahlen für die einzelnen Studiengänge an der Universität zu Lübeck. Für die Jahre 1998 und früher liegen leider keine genauen Zahlen für die Mediziner vor, die Angaben sind geschätzt. 
        <br/>
        <br/>
        Dieses Diagramm wurde ursprünglich im Oktober 2013 programmiert und im Oktober 2015 aktualisiert.</p>
        <div id="chart">
            <form id="coursecheckboxes">
                <label id="checkmed"><input type="checkbox" name="course" value="med" checked>Humanmedizin</label>
                <label id="checkinfo"><input type="checkbox" name="course" value="info" checked>Informatik</label>
                <label id="checkmedinfo"><input type="checkbox" name="course" value="medinfo" checked>Medizinische Informatik</label>
                <label id="checkmedieninfo"><input type="checkbox" name="course" value="medieninfo" checked>Medieninformatik</label>
                <label id="checkmls"><input type="checkbox" name="course" value="mls" checked>MLS</label>
                <label id="checkmath"><input type="checkbox" name="course" value="math" checked>CLS/MML</label>
                <label id="checkmiw"><input type="checkbox" name="course" value="miw" checked>MIW</label>
                <label id="checkpsycho"><input type="checkbox" name="course" value="psycho" checked>Psychologie</label>
                <label id="checkpflege"><input type="checkbox" name="course" value="pflege" checked>Pflege</label>
            </form>
        </div>
        <script type="text/javascript">

            var w = 1000;
            var h = 500;
            var spacing = 1;
            var marginbottom = 20;
            var margintop = 20;
            var colors = {
                med:"#a60000",
                info:"#1b1bb3",
                mls:"#008500",
                math:"#ff5300",
                miw:"#c7007d",
                medinfo:"#50026e",
                medieninfo:"#9933cc",
                psycho:"#408ad2",
                pflege:"#00cc99"
            };

            var color = [colors.med, colors.info, colors.medinfo, colors.medieninfo, colors.mls, colors.math, colors.miw, colors.psycho, colors.pflege];

            d3.select("#checkmed")
                .style("background-color", colors.med)
                .select("input")
                    .on("change", checkMed);
            d3.select("#checkinfo").style("background-color", colors.info)
                .select("input")
                    .on("change", checkInfo);
            d3.select("#checkmedinfo").style("background-color", colors.medinfo)
                .select("input")
                    .on("change", checkMedInfo);
            d3.select("#checkmedieninfo").style("background-color", colors.medieninfo)
                .select("input")
                    .on("change", checkMedienInfo);
            d3.select("#checkmls").style("background-color", colors.mls)
                .select("input")
                    .on("change", checkMls);
            d3.select("#checkmath").style("background-color", colors.math)
                .select("input")
                    .on("change", checkMath);
            d3.select("#checkmiw").style("background-color", colors.miw)
                .select("input")
                    .on("change", checkMiw);
            d3.select("#checkpsycho").style("background-color", colors.psycho)
                .select("input")
                    .on("change", checkPsycho);
            d3.select("#checkpflege").style("background-color", colors.pflege)
                .select("input")
                    .on("change", checkPflege);

            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", w)
                .attr("height", h);
            
            var stack = d3.layout.stack();


            var m;
            var x,y;
            var layerEmpty, layerMed, layerInfo, layerMedInfo, layerMedienInfo, layerMls, layerMath, layerMiw, layerPsycho, layerPflege;

            var layers;
            var sums;
            var years;

            d3.csv("https://raw.githubusercontent.com/StudentenPACK/open-data/1eac7595ff26053d1198385e1a45936cf3b79e97/erstsemester.csv", 
                function(d){
                    return {
                        year: new Date(+d.Jahr, 0, 1),
                        freshmen: +d['Erstis'],
                        freshmenMed: +(d['Jahr']>1999?d['E_Medizin']:200), //default 200 for pre 1999
                        freshmenInfo: +d['E_Informatik'],
                        freshmenMls: +d['E_MLS'],
                        freshmenMath: +d['E_CLS/MML'],
                        freshmenMiw: +d['E_MIW'],
                        freshmenMedInfo: +d['E_Medizinische_Informatik'],
                        freshmenPsycho: +d['E_Psychologie'],
                        freshmenMedienInfo: +d['E_Medieninformatik'],
                        freshmenPflege: +d['E_Pflege'],
                        sources: d.Quellen
                    };
                }, function(error, rows){
                    if(rows==null){
                        d3.select("#description").text("oh noes! something went horribly wrong! There is no data!");
                    } else {
                        populateFields(rows);
                        layers = [layerMed, layerInfo, layerMedInfo, layerMedienInfo, layerMls, layerMath, layerMiw, layerPsycho, layerPflege];
                        stack(layers);
                        redraw();
                    }
                });

                function populateFields(data){
                    m = data.length;
                    layerEmpty = d3.range(m).map(function(d,i){return {x:i, y:0}});
                    layerMed = data.map(function(d,i){return {x:i, y:d.freshmenMed}});
                    layerInfo = data.map(function(d,i){return {x:i, y:d.freshmenInfo}});
                    layerMedInfo = data.map(function(d,i){return {x:i, y:d.freshmenMedInfo}});
                    layerMedienInfo = data.map(function(d,i){return {x:i, y:d.freshmenMedienInfo}});
                    layerMls = data.map(function(d,i){return {x:i, y:d.freshmenMls}});
                    layerMath = data.map(function(d,i){return {x:i, y:d.freshmenMath}});
                    layerMiw = data.map(function(d,i){return {x:i, y:d.freshmenMiw}});
                    layerPsycho = data.map(function(d,i){return {x:i, y:d.freshmenPsycho}});
                    layerPflege = data.map(function(d,i){return {x:i, y:d.freshmenPflege}});

                    years = data.map(function(x){return x.year.getFullYear()})

                    x = d3.scale.ordinal()
                        .domain(d3.range(m))
                        .rangeRoundBands([0, w], .08);

                    y = d3.scale.linear()
                        .domain([0, d3.max(data, function(d) { return d.freshmen; })])
                        .range([h - marginbottom, 0 + margintop]);
                }

                function checkMed(){
                    if (this.checked){
                        layers[0] = layerMed;
                    } else {
                        layers[0] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }

                function checkInfo(){
                    if (this.checked){
                        layers[1] = layerInfo;
                    } else {
                        layers[1] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }

                function checkMedInfo(){
                    if (this.checked){
                        layers[2] = layerMedInfo;
                    } else {
                        layers[2] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }

                function checkMedienInfo(){
                    if (this.checked){
                        layers[3] = layerMedienInfo;
                    } else {
                        layers[3] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }


                function checkMls(){
                    if (this.checked){
                        layers[4] = layerMls;
                    } else {
                        layers[4] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }

                function checkMath(){
                    if (this.checked){
                        layers[5] = layerMath;
                    } else {
                        layers[5] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }

                function checkMiw(){
                    if (this.checked){
                        layers[6] = layerMiw;
                    } else {
                        layers[6] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }

                function checkPsycho(){
                    if (this.checked){
                        layers[7] = layerPsycho;
                    } else {
                        layers[7] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }

                function checkPflege(){
                    if (this.checked){
                        layers[8] = layerPflege;
                    } else {
                        layers[8] = layerEmpty;
                    }
                    stack(layers);
                    redraw();
                }


                function redraw(){
                    svg.selectAll(".layer").remove();
                    svg.selectAll("g").remove();
                    var layer = svg.selectAll(".layer")
                        .data(layers)
                        .enter()
                        .append("g")
                            .attr("class", "layer")
                            .style("fill", function(d, i) { return color[i]; });

                    var rect = layer.selectAll("rect")
                        .data(function(d) { return d; })
                        .enter();
                    rect.append("rect")
                        .attr("x", function(d) { return x(d.x); })
                        .attr("y", function(d) { return y(d.y0 + d.y); })
                        .attr("width", x.rangeBand())
                        .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); });
                    rect.append("text")
                        .text(function(d){if (d.y > 0) {return d.y}})
                        .attr("text-anchor", "middle")
                        .attr("dominant-baseline", "middle")
                        .attr("x", function(d, i) {
                            return x(i)+x.rangeBand()/2;
                        })
                        .attr("y", function(d) { return y(d.y0 + d.y/2); })
                        .attr("fill", "#fff")
                        .style("font-size", "10px")
                        .style("font-family", "Helvetica, Arial, sans-serif");

                    //Summen
                    var labelsSum = svg.selectAll(".labels_sum")
                        .data(layers[layers.length-1])
                        .enter()
                        .append("g")
                            .attr("class", "labels")
                            .attr("fill", "#000")
                            .style("font-size", "12px")
                            .style("font-family", "Helvetica, Arial, sans-serif");
                    labelsSum.append("text")
                        .text(function(d){
                            return d.y0 + d.y;
                        })
                        .attr("text-anchor", "middle")
                        .attr("x", function(d, i) {
                            return x(i)+x.rangeBand()/2;
                        })
                        .attr("y", function(d) {
                            return y(d.y0 + d.y) - 25 + marginbottom;
                        });

                    //Jahre
                    var labelsYear = svg.selectAll(".labels_year")
                        .data(years)
                        .enter()
                        .append("g")
                            .attr("class", "labels_year")
                            .attr("fill", "#000")
                            .style("font-size", "12px")
                            .style("font-family", "Helvetica, Arial, sans-serif");
                    labelsYear.append("text")
                        .text(function(d){
                            return d;
                        })
                        .attr("text-anchor", "middle")
                        .attr("x", function(d, i) {
                            return x(i)+x.rangeBand()/2;
                        })
                        .attr("y", function(d) {
                            return h - 5;
                        });
                }
        </script>
        <div id="sources" class="text">
            <h2>Quellen</h2>
            <p>Rohdaten in dieser <a href="https://github.com/StudentenPACK/open-data/blob/master/erstsemester.csv" target="_blank">csv-Datei</a>. Quellen für die einzelnen Jahre sind dort notiert.</p>
        </div>
    </body>
</html>    